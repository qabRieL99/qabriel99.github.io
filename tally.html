<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigara Takip Pro+</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f5f7fa; --card: #ffffff; --text: #333; --border: #eee;
            --primary: #4a90e2; --danger: #ff5252; --success: #4caf50;
        }
        [data-theme="dark"] {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333;
            --primary: #64b5f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); transition: 0.3s; margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; }
        .theme-toggle { cursor: pointer; font-size: 1.2rem; margin-bottom: 15px; display: inline-block; }
        .info-card { 
            background: var(--card); padding: 20px; border-radius: 12px; text-align: center; 
            border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
        }
        .info-card small { display: block; font-size: 0.85em; color: #888; margin-bottom: 5px; }
        .info-card span { font-size: 1.5em; font-weight: bold; color: var(--primary); }
        .card { background: var(--card); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; overflow: hidden; border: 1px solid var(--border); }
        .timer-box { text-align: center; margin-bottom: 20px; color: var(--success); font-weight: bold; font-size: 0.95em; height: 1.2em; }
        .accordion-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border); }
        .accordion-header.active { border-left: 5px solid var(--primary); background: rgba(74, 144, 226, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
        .today-row { background: rgba(74, 144, 226, 0.1); font-weight: bold; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; touch-action: manipulation; }
        button:active { transform: scale(0.95); }
        .btn-plus { background: var(--success); color: white; padding: 10px 20px; font-size: 1.2em; }
        .btn-minus { background: #666; color: white; padding: 10px 20px; font-size: 1.2em; }
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; margin-bottom: 15px; }
        .analysis-box { padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Tema DeÄŸiÅŸtir</span>
        <span style="font-size: 0.8em; color: #888;">v4.2 Final</span>
    </div>

    <div class="info-card">
        <small>ðŸ’³ Bu Haftaki Toplam Maliyet</small>
        <span id="costText">0 â‚º</span>
    </div>

    <div id="lastSmoked" class="timer-box">HesaplanÄ±yor...</div>

    <button class="btn-main" onclick="toggleStats()">ðŸ“Š Ä°statistikler & KarÅŸÄ±laÅŸtÄ±rma</button>

    <div id="statsSection" class="card" style="display:none; padding: 15px;">
        <div id="analysisText" class="analysis-box"></div>
        <div style="height: 220px;"><canvas id="statChart"></canvas></div>
    </div>

    <div id="haftalar"></div>
</div>

<script>
const FIYAT_PAKET = 90; 
const ADET_PAKET = 20;
const ADET_MALIYET = FIYAT_PAKET / ADET_PAKET;
const KEY = "sigaraTakip_V4_2"; 

let chart = null;

function yukle() { 
    const raw = localStorage.getItem(KEY);
    return raw ? JSON.parse(raw) : { data: [], lastTimestamp: null }; 
}

function kaydet(d) { localStorage.setItem(KEY, JSON.stringify(d)); }

function toggleTheme() {
    const theme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
}

function pazartesiBul(d) {
    const t = new Date(d);
    // Saati, dakikayÄ±, saniyeyi sÄ±fÄ±rla ki yerel saatin baÅŸlangÄ±cÄ± (00:00) olsun
    t.setHours(0, 0, 0, 0); 
    
    const day = t.getDay() || 7; // Pazar=0 ise 7 olsun
    t.setDate(t.getDate() - day + 1);
    
    // Yerel saati koruyarak 'YYYY-MM-DD' formatÄ±nÄ± elle oluÅŸtur.
    const year = t.getFullYear();
    const month = String(t.getMonth() + 1).padStart(2, '0');
    const dayOfMonth = String(t.getDate()).padStart(2, '0');
    return `${year}-${month}-${dayOfMonth}`;
}

function haftaKontrol() {
    let store = yukle();
    const pz = pazartesiBul(new Date()); 
    
    if (store.data.length === 0 || store.data[store.data.length - 1][0].tarih !== pz) {
        const h = [];
        // pz (Pazartesi tarihi) zaten YYYY-MM-DD formatÄ±nda olduÄŸu iÃ§in:
        const pzDate = new Date(pz + 'T00:00:00'); // Yeni tarih objesini bu yerel tarihle oluÅŸtur
        
        for (let i = 0; i < 7; i++) {
            const d = new Date(pzDate); 
            d.setDate(pzDate.getDate() + i); // pzDate'in yerel tarihini 1'er gÃ¼n artÄ±r
            
            // Yerel saati koruyarak YYYY-MM-DD formatÄ±nÄ± elle oluÅŸtur
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const dayOfMonth = String(d.getDate()).padStart(2, '0');
            
            h.push({ tarih: `${year}-${month}-${dayOfMonth}`, sayi: 0 });
        }
        store.data.push(h);
        kaydet(store);
    }
}

function degistir(h, g, m) {
    let store = yukle();
    store.data[h][g].sayi = Math.max(0, store.data[h][g].sayi + m);
    if(m > 0) store.lastTimestamp = new Date().getTime();
    kaydet(store);
    render();
    if(document.getElementById("statsSection").style.display === "block") refreshStats();
}

function guncelleTimer() {
    const store = yukle();
    const el = document.getElementById("lastSmoked");
    if(!store.lastTimestamp) {
        el.innerText = "HenÃ¼z sigara girilmedi.";
        return;
    }
    const fark = new Date().getTime() - store.lastTimestamp;
    const saat = Math.floor(fark / 3600000);
    const dk = Math.floor((fark % 3600000) / 60000);
    el.innerText = `â± Son sigaradan beri: ${saat} sa ${dk} dk geÃ§ti`;
}

function render() {
    const store = yukle();
    const data = [...store.data].reverse();
    
    const now = new Date();
    // Yerel saati koruyarak 'YYYY-MM-DD' formatÄ±nÄ± elle oluÅŸtur.
    const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    
    const buHaftaTotal = store.data[store.data.length-1].reduce((s,g)=>s+g.sayi,0);
    document.getElementById("costText").innerText = (buHaftaTotal * ADET_MALIYET).toFixed(2) + " â‚º";

    const container = document.getElementById("haftalar");
    container.innerHTML = "";
    
    data.forEach((hafta, revIdx) => {
        const i = data.length - 1 - revIdx;
        const isCurrent = hafta.some(g => g.tarih === today);
        container.innerHTML += `
            <div class="card">
                <div class="accordion-header ${isCurrent?'active':''}" onclick="toggleAccordion(this)">
                    <span>ðŸ“… ${hafta[0].tarih}</span>
                    <span>HaftalÄ±k: ${hafta.reduce((s,g)=>s+g.sayi,0)} â–¾</span>
                </div>
                <div style="display: ${isCurrent?'block':'none'}">
                    <table>
                        ${hafta.map((g, j) => {
                            const isToday = g.tarih === today;
                            const gunAdi = new Date(g.tarih).toLocaleDateString('tr-TR', {weekday:'long'});
                            const etiket = isToday ? '<span style="color:white; background:#4a90e2; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 8px;">BUGÃœN</span>' : '';
                            
                            return `
                                <tr class="${isToday ? 'today-row' : ''}">
                                    <td style="text-align:left">${gunAdi}${etiket}</td>
                                    <td style="font-size:1.2em"><b>${g.sayi}</b></td>
                                    <td>
                                        <div style="display:flex; gap:5px; justify-content:center;">
                                            <button class="btn-minus" onclick="degistir(${i},${j},-1)">-</button>
                                            <button class="btn-plus" onclick="degistir(${i},${j},1)">+</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </table>
                </div>
            </div>`;
    });
}

function toggleAccordion(el) {
    const content = el.nextElementSibling;
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
    el.classList.toggle('active');
}

function toggleStats() {
    const s = document.getElementById("statsSection");
    s.style.display = s.style.display === "none" ? "block" : "none";
    if (s.style.display === "block") refreshStats();
}

function refreshStats() {
    const store = yukle();
    const hafta = store.data[store.data.length-1];
    const labels = hafta.map(g => new Date(g.tarih).toLocaleDateString('tr-TR', {weekday:'short'}));
    const values = hafta.map(g => g.sayi);

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById('statChart'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Adet', data: values, borderColor: '#4a90e2', tension: 0.2, fill: true, backgroundColor: 'rgba(74, 144, 226, 0.1)' }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });

    // 1. DÃ¼zeltme: Yerel Saate GÃ¶re BugÃ¼nÃ¼n Tarihini YYYYY-MM-DD formatÄ±nda al
    const now = new Date();
    const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    
    const bugun = (hafta.find(g => g.tarih === todayStr) || {sayi: 0}).sayi;
    const bugunIdx = hafta.findIndex(g => g.tarih === todayStr);
    
    let analiz = `<strong>KarÅŸÄ±laÅŸtÄ±rma:</strong><br>`;
    
    // 2. Analiz DÃ¼zeltmesi: bugunIdx 0'dan bÃ¼yÃ¼kse (yani Pazartesi deÄŸilse) karÅŸÄ±laÅŸtÄ±rma yap
    if (bugunIdx > 0) {
        const dun = hafta[bugunIdx - 1].sayi;
        const fark = bugun - dun;
        
        if (dun === 0 && bugun === 0) {
             analiz += "DÃ¼n de bugÃ¼n de tertemiz! ðŸ‘";
        } else if (dun === 0 && bugun > 0) {
            analiz += `âš ï¸ DÃ¼n hiÃ§ iÃ§memiÅŸtin, bugÃ¼n ${bugun} adet iÃ§tin. Dikkat!`;
        } else if (bugun === 0 && dun > 0) {
            analiz += `ðŸŽ‰ DÃ¼n ${dun} adet iÃ§miÅŸtin, bugÃ¼n sÄ±fÄ±r! MÃ¼thiÅŸ bir baÅŸarÄ±!`;
        } else { // Hem dÃ¼n hem bugÃ¼n > 0 ise yÃ¼zde hesapla
            const yuzde = Math.abs(Math.round((fark / dun) * 100));
            
            if (fark > 0) {
                analiz += `ðŸ“ˆ DÃ¼ne (${dun} adet) gÃ¶re %${yuzde} artÄ±ÅŸ var.`;
            } else if (fark < 0) {
                analiz += `ðŸ“‰ DÃ¼ne (${dun} adet) gÃ¶re %${yuzde} daha az iÃ§tin. Harika!`;
            } else {
                analiz += "âš–ï¸ DÃ¼n ile aynÄ± sayÄ±dasÄ±n.";
            }
        }
    } else { 
        // BugÃ¼n Pazartesi ise (bugunIdx === 0) veya tarih bulunamazsa 
        analiz += "HaftanÄ±n ilk gÃ¼nÃ¼ndesin (Pazartesi). DÃ¼nkÃ¼ veriler (geÃ§en hafta) ile karÅŸÄ±laÅŸtÄ±rÄ±lamaz."; 
    }
    
    document.getElementById("analysisText").innerHTML = analiz;
}

if(localStorage.getItem("theme") === "dark") document.documentElement.setAttribute("data-theme", "dark");
haftaKontrol();
render();
setInterval(guncelleTimer, 30000); 
guncelleTimer();
</script>
</body>
</html>
